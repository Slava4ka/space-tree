import XLSX from 'xlsx';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// –ü—É—Ç—å –∫ xlsx —Ñ–∞–π–ª—É
const xlsxFilePath = path.join(__dirname, 'ntr_full_matrix.xlsx');
const outputJsonPath = path.join(__dirname, 'ntr_full_matrix.json');

try {
  // –ß–∏—Ç–∞–µ–º xlsx —Ñ–∞–π–ª
  const workbook = XLSX.readFile(xlsxFilePath);
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
  const firstSheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[firstSheetName];
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ª–∏—Å—Ç –≤ –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤
  const rawData = XLSX.utils.sheet_to_json(worksheet, {
    header: 1,
    defval: null,
    raw: false
  });
  
  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫)
  const dataRows = rawData.slice(2);
  
  // –°–æ–∑–¥–∞–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
  const result = {};
  
  dataRows.forEach(row => {
    // row[0] - –í—ã–∑–æ–≤_ID (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º)
    // row[1] - –í—ã–∑–æ–≤_–ù–∞–∑–≤–∞–Ω–∏–µ
    // row[2] - –ó–∞–¥–∞—á–∞_–ù–∞–∑–≤–∞–Ω–∏–µ
    // row[3] - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è_–ù–∞–∑–≤–∞–Ω–∏–µ
    
    const –≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ = row[1];
    const –∑–∞–¥–∞—á–∞–ù–∞–∑–≤–∞–Ω–∏–µ = row[2];
    const —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ù–∞–∑–≤–∞–Ω–∏–µ = row[3];
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    if (!–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ || !–∑–∞–¥–∞—á–∞–ù–∞–∑–≤–∞–Ω–∏–µ || !—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ù–∞–∑–≤–∞–Ω–∏–µ) {
      return;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –≤—ã–∑–æ–≤–∞, –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
    if (!result[–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ]) {
      result[–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ] = {};
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
    if (!result[–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ][–∑–∞–¥–∞—á–∞–ù–∞–∑–≤–∞–Ω–∏–µ]) {
      result[–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ][–∑–∞–¥–∞—á–∞–ù–∞–∑–≤–∞–Ω–∏–µ] = [];
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç (—É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
    if (!result[–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ][–∑–∞–¥–∞—á–∞–ù–∞–∑–≤–∞–Ω–∏–µ].includes(—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ù–∞–∑–≤–∞–Ω–∏–µ)) {
      result[–≤—ã–∑–æ–≤–ù–∞–∑–≤–∞–Ω–∏–µ][–∑–∞–¥–∞—á–∞–ù–∞–∑–≤–∞–Ω–∏–µ].push(—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–ù–∞–∑–≤–∞–Ω–∏–µ);
    }
  });
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–∞–π–ª
  fs.writeFileSync(outputJsonPath, JSON.stringify(result, null, 2), 'utf8');
  
  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  const –≤—ã–∑–æ–≤—ãCount = Object.keys(result).length;
  let –∑–∞–¥–∞—á–∏Count = 0;
  let —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏Count = 0;
  
  Object.values(result).forEach(–∑–∞–¥–∞—á–∏ => {
    –∑–∞–¥–∞—á–∏Count += Object.keys(–∑–∞–¥–∞—á–∏).length;
    Object.values(–∑–∞–¥–∞—á–∏).forEach(—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ => {
      —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏Count += —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏.length;
    });
  });
  
  console.log(`‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
  console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:`);
  console.log(`   - –í—ã–∑–æ–≤–æ–≤: ${–≤—ã–∑–æ–≤—ãCount}`);
  console.log(`   - –ó–∞–¥–∞—á: ${–∑–∞–¥–∞—á–∏Count}`);
  console.log(`   - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–π: ${—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏Count}`);
  console.log(`üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${outputJsonPath}`);
  
} catch (error) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error.message);
  process.exit(1);
}

